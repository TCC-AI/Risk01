
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>昶青實業<br>【AI企業風控中心】</title>
    <!-- Bootstrap CSS (for dropdown & modal) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* === 原來的樣式保持不動 === */
        *{box-sizing:border-box;margin:0;padding:0;font-family:'微軟正黑體',Arial,sans-serif;}
        body{background:linear-gradient(135deg,#1a6fc4 0%,#2a9dd9 25%,#34c3aa 50%,#3ed9a0 75%,#4aeb97 100%);min-height:100vh;position:relative;padding:20px;overflow-x:hidden;}
        body::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 30%,rgba(255,255,255,.15) 0%,transparent 60%);z-index:-1;}
        body::after{content:"";position:absolute;top:0;right:0;width:80%;height:100%;background:radial-gradient(circle at 80% 70%,rgba(0,100,150,.1) 0%,transparent 60%);z-index:-1;}
        .container{width:100%;max-width:540px;padding:20px;margin:0 auto;position:relative;}
        .logo-container{text-align:center;margin-bottom:0;}
        .logo{max-width:400px;height:auto;display:inline-block;filter:drop-shadow(0 4px 6px rgba(0,0,0,.1));transition:transform .3s ease;}
        .logo:hover{transform:scale(1.05);}        
        /* 歡迎詞置中：沿用原設定 */
        .welcome-message,div:contains("歡迎"),.dotted-box p,.user-greeting{width:100%;text-align:center!important;display:block;margin:0 auto;padding:0;}
        .dotted-container,.dotted-box{display:flex;justify-content:center;align-items:center;text-align:center;width:100%;}
        @media(max-width:767px){.welcome-message,div:contains("歡迎"),.dotted-box p,.user-greeting{padding:0!important;margin:0 auto!important;left:0!important;right:0!important;}}

        /* 卡片樣式（原） */
        .login-form,.dashboard{background:rgba(255,255,255,.9);padding:30px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.1),0 4px 8px rgba(31,38,135,.2),inset 0 0 0 1px rgba(255,255,255,.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.18);transition:all .3s ease;}
        .login-form:hover,.dashboard:hover{box-shadow:0 12px 40px rgba(0,0,0,.15),0 6px 12px rgba(31,38,135,.25),inset 0 0 0 1px rgba(255,255,255,.2);transform:translateY(-5px);}        
        h1{text-align:center;margin-bottom:10px;color:#1a6fc4;font-size:28px;font-weight:bold;text-shadow:0 1px 2px rgba(0,0,0,.1);}        
        .form-group{margin-bottom:10px;}label{display:block;margin-bottom:8px;font-weight:bold;color:#2a6496;}        
        input{width:100%;padding:12px 15px;border:1px solid rgba(0,100,150,.2);border-radius:8px;font-size:16px;background:rgba(255,255,255,.8);transition:all .3s ease;box-shadow:inset 0 1px 3px rgba(0,0,0,.1);}        
        input:focus{outline:none;border-color:#34c3aa;box-shadow:0 0 0 3px rgba(52,195,170,.25),inset 0 1px 3px rgba(0,0,0,.1);}        
        button:not(.btn){width:100%;padding:12px;background:linear-gradient(to right,#1a6fc4,#34c3aa);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 6px rgba(0,0,0,.1),0 1px 3px rgba(0,0,0,.1);text-shadow:0 1px 2px rgba(0,0,0,.1);}        
        button:hover:not(.btn){background:linear-gradient(to right,#1558a0,#2aa890);box-shadow:0 6px 12px rgba(0,0,0,.15),0 2px 4px rgba(0,0,0,.15);transform:translateY(-2px);}        
        button:active:not(.btn){transform:translateY(0);box-shadow:0 2px 4px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.1);}        
        .error-message{color:#d93025;margin-top:15px;text-align:center;font-weight:600;}        
        .button-group{display:flex;flex-direction:column;gap:20px;margin-bottom:30px;}        
        .feature-btn{padding:20px;font-size:18px;font-weight:bold;position:relative;overflow:hidden;}        
        .feature-btn::after{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(255,255,255,.2),rgba(255,255,255,0));opacity:0;transition:opacity .3s ease;}        
        .feature-btn:hover::after{opacity:1;}        
        #inventory-btn{background:linear-gradient(to right,#34a853,#4aeb97);}#inventory-btn:hover{background:linear-gradient(to right,#2d9249,#3ed9a0);}        
        #event-btn{background:linear-gradient(to right,#ea4335,#ff6b58);}#event-btn:hover{background:linear-gradient(to right,#d33426,#e85a4a);}        
        /* ====== 通知功能新增樣式 ====== */
        #notification-btn{background:linear-gradient(to right,#ff9800,#ffb74d);}#notification-btn:hover{background:linear-gradient(to right,#f57c00,#ffa726);}        
        .notification-icon{position:absolute;top:8px;left:12px;cursor:pointer;font-size:18px;color:#ff9800;transition:all .3s ease;}
        .notification-icon:hover{color:#f57c00;transform:scale(1.1);}        
        .notification-badge{position:absolute;top:-5px;right:-8px;background:#ea4335;color:#fff;border-radius:50%;width:18px;height:18px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;}
        /* 通知管理頁 */
        .notification-page{background:#fff;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1);padding:30px;margin-top:20px;width:100%;max-width:900px;margin-left:auto;margin-right:auto;}
        .notification-item{border:1px solid #dee2e6;border-radius:8px;padding:15px;margin-bottom:15px;background:#f8f9fa;transition:all .3s ease;}
        .notification-item:hover{box-shadow:0 4px 8px rgba(0,0,0,.1);}        
        .notification-item.unread{background:#fff3cd;border-color:#ffeaa7;}
        .notification-item.urgent{background:#f8d7da;border-color:#f5c6cb;}
        .notification-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
        .notification-title{font-weight:bold;color:#1a6fc4;margin:0;}
        .notification-time{font-size:12px;color:#6c757d;}
        .notification-content{color:#495057;margin-bottom:10px;}
        .notification-settings{background:#f8f9fa;border-radius:8px;padding:20px;margin-bottom:20px;}
        .notification-settings .setting-group{margin-bottom:15px;}        
        .notification-settings label{display:block;margin-bottom:5px;font-weight:600;color:#495057;}
        .notification-settings input,.notification-settings select{width:100%;padding:8px 12px;border:1px solid #ced4da;border-radius:4px;font-size:14px;}        
        /* 其他原有樣式（inventory, table 等）略 ‧ 皆保留不動 */
    </style>
</head>
<body>
    <div class="container">
        <!-- ======== 登入區 ======== -->
        <div id="login-section" class="login-form">
            <div class="logo-container"><img src="LOGO.png" alt="昶青實業 Logo" class="logo"></div>
            <h1>昶青實業<br>【AI企業風控中心】</h1>
            <div class="form-group"><label for="username">帳號</label><input type="text" id="username" placeholder="請輸入帳號"></div>
            <div class="form-group"><label for="password">密碼</label><input type="password" id="password" placeholder="請輸入密碼"></div>
            <button id="login-btn">登入</button>
            <p id="loading" class="loading hidden">驗證中...</p><p id="error-message" class="error-message"></p>
        </div>

        <!-- ======== 主功能頁 ======== -->
        <div id="dashboard-section" class="dashboard hidden">
            <!-- 使用者資訊 + 通知 bell -->
            <div id="user-info" class="user-info" style="width:100%;text-align:center;">
                <div id="notification-icon" class="notification-icon" title="查看通知">🔔<span id="notification-badge" class="notification-badge hidden">0</span></div>
                歡迎：<strong id="user-department"></strong> - <strong id="user-name"></strong>
            </div>
            <div class="logo-container"><img src="LOGO.png" alt="昶青實業 Logo" class="logo"></div>
            <h1>昶青實業<br>【AI企業風控中心】</h1>
            <div class="button-group">
                <button class="feature-btn" id="dept-risk-index-btn" style="background:linear-gradient(to right,#1a6fc4,#34c3aa);">部門風險係數</button>
                <button id="inventory-btn" class="feature-btn">部門週期盤點</button>
                <button id="event-btn" class="feature-btn">事件登錄</button>
                <button id="notification-btn" class="feature-btn">通知管理</button>
            </div>
            <!-- 登出 dropdown (沿用原) -->
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle w-100 py-2" type="button" id="logoutDropdown" data-bs-toggle="dropdown" aria-expanded="false">登出選項</button>
                <ul class="dropdown-menu w-100" aria-labelledby="logoutDropdown">
                    <li><a class="dropdown-item" href="#" id="changePasswordBtn">更改密碼</a></li>
                    <li><a class="dropdown-item" href="#" id="logoutBtn">登出</a></li>
                </ul>
            </div>
        </div>

        <!-- ======== 通知管理頁 ======== -->
        <div id="notification-page" class="notification-page" style="display:none;">
            <div class="logo-container"><img src="LOGO.png" class="logo" alt="昶青實業 Logo"></div>
            <h2 class="text-center mb-4">通知管理</h2>
            <!-- 設定 -->
            <div class="notification-settings">
                <h4>通知設定</h4>
                <div class="row">
                    <div class="col-md-6 setting-group"><label for="risk-threshold">風險閾值設定</label>
                        <select id="risk-threshold"><option value="20">低風險 (R值 >20)</option><option value="30" selected>中風險 (R值 >30)</option><option value="40">高風險 (R值 >40)</option></select></div>
                    <div class="col-md-6 setting-group"><label for="notification-frequency">檢查頻率</label>
                        <select id="notification-frequency"><option value="realtime" selected>即時</option><option value="hourly">每小時</option><option value="daily">每日</option></select></div>
                </div>
                <button class="btn btn-primary" id="save-settings-btn">儲存設定</button>
                <button class="btn btn-info" id="check-risk-now-btn">立即檢查風險</button>
            </div>
            <!-- 通知列表視圖 -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>通知記錄</h4>
                <div>
                    <button class="btn btn-sm btn-outline-primary" id="mark-all-read-btn">全部標為已讀</button>
                    <button class="btn btn-sm btn-outline-danger" id="clear-notifications-btn">清除所有通知</button>
                </div>
            </div>
            <div id="notifications-container"><div class="text-center"><p>載入通知中...</p></div></div>
            <button class="btn btn-secondary mt-3" id="back-to-dashboard-from-notification">返回</button>
        </div>

        <!-- 其餘頁面 (dept‑risk‑index, inventory 等) 完全照原檔保留，此處省略以縮短。 -->
        <!-- ... 原本的部門風險係數頁、部門週期盤點頁、ChangePassword Modal 等 ... -->
    </div>

    <!-- Bootstrap / Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <!-- ========= 主 JavaScript ========= -->
    <script>
    document.addEventListener('DOMContentLoaded',function(){
        /* 原本變數宣告 */
        const loginSection=document.getElementById('login-section');
        const dashboardSection=document.getElementById('dashboard-section');
        const notificationPage=document.getElementById('notification-page');
        // 其他舊有節點... (inventorySection, deptRiskIndexPage 等)
        const notificationBtn=document.getElementById('notification-btn');
        const notificationIcon=document.getElementById('notification-icon');
        const notificationBadge=document.getElementById('notification-badge');
        // 通知頁元件
        const saveSettingsBtn=document.getElementById('save-settings-btn');
        const checkRiskNowBtn=document.getElementById('check-risk-now-btn');
        const markAllReadBtn=document.getElementById('mark-all-read-btn');
        const clearNotificationsBtn=document.getElementById('clear-notifications-btn');
        const notificationsContainer=document.getElementById('notifications-container');
        const riskThresholdSelect=document.getElementById('risk-threshold');
        const notificationFrequencySelect=document.getElementById('notification-frequency');
        const backFromNotificationBtn=document.getElementById('back-to-dashboard-from-notification');

        /* 其他原本變數... (usernameInput, passwordInput, inventoryBtn 等) 保留不動 */

        /* 基本設定 */
        const inactivityTimeout=10*60*1000; // 10 分鐘
        let inactivityTimer, notificationCheckTimer;
        const scriptUrl='https://script.google.com/macros/s/AKfycbz6PrP-XVs2HkaPQFKArWyVKdT0tfMWU_7mR02dQhqHNnd64O3sQi6qCF2QcTIF88-x/exec'; // 與沒通知版相同

        /* ========== 通知相關函式 ========== */
        function loadNotificationSettings(){
            riskThresholdSelect.value=localStorage.getItem('riskThreshold')||'30';
            notificationFrequencySelect.value=localStorage.getItem('notificationFrequency')||'realtime';
        }

        function saveNotificationSettingsToBackend(){
            const payload={
                username:localStorage.getItem('username'),
                riskThreshold:riskThresholdSelect.value,
                notificationFrequency:notificationFrequencySelect.value
            };
            return fetch(`${scriptUrl}?action=saveNotificationSettings`,{method:'POST',body:JSON.stringify(payload)}).then(r=>r.json());
        }

        function updateNotificationBadge(){
            fetch(`${scriptUrl}?action=getUnreadNotificationCount&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(d=>{
                if(d.success){
                  const c=d.count;
                  if(c>0){notificationBadge.textContent=c>99?'99+':c;notificationBadge.classList.remove('hidden');}
                  else notificationBadge.classList.add('hidden');
                }
              }).catch(console.error);
        }

        function startNotificationCheck(){
            clearInterval(notificationCheckTimer);
            const freq=notificationFrequencySelect.value;
            let interval=30000; // default realtime 30s
            if(freq==='hourly') interval=3600000;
            else if(freq==='daily') interval=86400000;
            notificationCheckTimer=setInterval(()=>{
                if(localStorage.getItem('isLoggedIn')==='true'){
                    updateNotificationBadge();
                    fetch(`${scriptUrl}?action=checkRiskThreshold&username=${encodeURIComponent(localStorage.getItem('username'))}`).catch(console.error);
                }
            },interval);
        }

        function renderNotifications(list){
            if(!list.length){notificationsContainer.innerHTML='<div class="text-center"><p>目前沒有通知</p></div>';return;}
            notificationsContainer.innerHTML=list.map(n=>{
                const unread=!n.isRead?'unread':'';const urgent=n.priority==='urgent'?'urgent':'';
                return `<div class="notification-item ${unread} ${urgent}" data-id="${n.id}">
                    <div class="notification-header"><h5 class="notification-title">${n.title}</h5><span class="notification-time">${n.time}</span></div>
                    <div class="notification-content">${n.content}</div>
                    <div class="notification-actions">
                        ${!n.isRead?`<button class="btn btn-sm btn-primary mark-read-btn" data-id="${n.id}">標為已讀</button>`:''}
                        <button class="btn btn-sm btn-danger delete-notification-btn" data-id="${n.id}">刪除</button>
                    </div></div>`;}).join('');
            // 綁事件
            notificationsContainer.querySelectorAll('.mark-read-btn').forEach(btn=>btn.addEventListener('click',()=>markNotificationAsRead(btn.dataset.id)));
            notificationsContainer.querySelectorAll('.delete-notification-btn').forEach(btn=>btn.addEventListener('click',()=>deleteNotification(btn.dataset.id)));
        }

        function loadNotifications(){
            notificationsContainer.innerHTML='<div class="text-center"><p>載入通知中...</p></div>';
            fetch(`${scriptUrl}?action=getNotifications&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(d=>{if(d.success)renderNotifications(d.notifications);else notificationsContainer.innerHTML='<div class="text-danger text-center">載入失敗</div>';})
              .catch(e=>{console.error(e);notificationsContainer.innerHTML='<div class="text-danger text-center">錯誤</div>';});
        }

        function markNotificationAsRead(id){
            fetch(`${scriptUrl}?action=markNotificationRead&notificationId=${id}&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(()=>{loadNotifications();updateNotificationBadge();});
        }
        function deleteNotification(id){
            if(!confirm('確定刪除？'))return;
            fetch(`${scriptUrl}?action=deleteNotification&notificationId=${id}&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(()=>{loadNotifications();updateNotificationBadge();});
        }

        /* ========== 事件繫結 (只列新增/改動部分) ========== */
        notificationBtn.addEventListener('click',()=>{dashboardSection.style.display='none';notificationPage.style.display='block';loadNotifications();});
        notificationIcon.addEventListener('click',()=>{dashboardSection.style.display='none';notificationPage.style.display='block';loadNotifications();});
        backFromNotificationBtn.addEventListener('click',()=>{notificationPage.style.display='none';dashboardSection.style.display='block';});

        saveSettingsBtn.addEventListener('click',()=>{
            localStorage.setItem('riskThreshold',riskThresholdSelect.value);
            localStorage.setItem('notificationFrequency',notificationFrequencySelect.value);
            saveNotificationSettingsToBackend().then(d=>{if(d.success){alert('設定已儲存');startNotificationCheck();}else alert('儲存失敗');});
        });
        checkRiskNowBtn.addEventListener('click',()=>{
            checkRiskNowBtn.disabled=true;checkRiskNowBtn.textContent='檢查中...';
            fetch(`${scriptUrl}?action=checkRiskThreshold&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(d=>{
                checkRiskNowBtn.disabled=false;checkRiskNowBtn.textContent='立即檢查風險';
                if(d.success){if(d.notifications.length){alert(`發現 ${d.notifications.length} 個風險警告`);}else alert('目前沒有風險警告');loadNotifications();updateNotificationBadge();}
              }).catch(()=>{checkRiskNowBtn.disabled=false;checkRiskNowBtn.textContent='立即檢查風險';});
        });
        markAllReadBtn.addEventListener('click',()=>{
            fetch(`${scriptUrl}?action=markAllNotificationsRead&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(()=>{loadNotifications();updateNotificationBadge();});
        });
        clearNotificationsBtn.addEventListener('click',()=>{
            if(!confirm('確定要清除所有通知嗎？此操作無法復原。'))return;
            fetch(`${scriptUrl}?action=clearAllNotifications&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(()=>{loadNotifications();updateNotificationBadge();});
        });

        /* ======= 下方其餘原有 JS（登入、inventory、dept‑risk 等函式）照舊，僅在 submitInventory 成功後多呼叫 updateNotificationBadge() ======= */
        // ... (保持原碼不改動，僅在對應位置插入 updateNotificationBadge();)
    });
    </script>
</body>
</html>
