
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜¶é’å¯¦æ¥­<br>ã€AIä¼æ¥­é¢¨æ§ä¸­å¿ƒã€‘</title>
    <!-- Bootstrap CSS (for dropdown & modal) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* === åŸä¾†çš„æ¨£å¼ä¿æŒä¸å‹• === */
        *{box-sizing:border-box;margin:0;padding:0;font-family:'å¾®è»Ÿæ­£é»‘é«”',Arial,sans-serif;}
        body{background:linear-gradient(135deg,#1a6fc4 0%,#2a9dd9 25%,#34c3aa 50%,#3ed9a0 75%,#4aeb97 100%);min-height:100vh;position:relative;padding:20px;overflow-x:hidden;}
        body::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 30%,rgba(255,255,255,.15) 0%,transparent 60%);z-index:-1;}
        body::after{content:"";position:absolute;top:0;right:0;width:80%;height:100%;background:radial-gradient(circle at 80% 70%,rgba(0,100,150,.1) 0%,transparent 60%);z-index:-1;}
        .container{width:100%;max-width:540px;padding:20px;margin:0 auto;position:relative;}
        .logo-container{text-align:center;margin-bottom:0;}
        .logo{max-width:400px;height:auto;display:inline-block;filter:drop-shadow(0 4px 6px rgba(0,0,0,.1));transition:transform .3s ease;}
        .logo:hover{transform:scale(1.05);}        
        /* æ­¡è¿è©ç½®ä¸­ï¼šæ²¿ç”¨åŸè¨­å®š */
        .welcome-message,div:contains("æ­¡è¿"),.dotted-box p,.user-greeting{width:100%;text-align:center!important;display:block;margin:0 auto;padding:0;}
        .dotted-container,.dotted-box{display:flex;justify-content:center;align-items:center;text-align:center;width:100%;}
        @media(max-width:767px){.welcome-message,div:contains("æ­¡è¿"),.dotted-box p,.user-greeting{padding:0!important;margin:0 auto!important;left:0!important;right:0!important;}}

        /* å¡ç‰‡æ¨£å¼ï¼ˆåŸï¼‰ */
        .login-form,.dashboard{background:rgba(255,255,255,.9);padding:30px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.1),0 4px 8px rgba(31,38,135,.2),inset 0 0 0 1px rgba(255,255,255,.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.18);transition:all .3s ease;}
        .login-form:hover,.dashboard:hover{box-shadow:0 12px 40px rgba(0,0,0,.15),0 6px 12px rgba(31,38,135,.25),inset 0 0 0 1px rgba(255,255,255,.2);transform:translateY(-5px);}        
        h1{text-align:center;margin-bottom:10px;color:#1a6fc4;font-size:28px;font-weight:bold;text-shadow:0 1px 2px rgba(0,0,0,.1);}        
        .form-group{margin-bottom:10px;}label{display:block;margin-bottom:8px;font-weight:bold;color:#2a6496;}        
        input{width:100%;padding:12px 15px;border:1px solid rgba(0,100,150,.2);border-radius:8px;font-size:16px;background:rgba(255,255,255,.8);transition:all .3s ease;box-shadow:inset 0 1px 3px rgba(0,0,0,.1);}        
        input:focus{outline:none;border-color:#34c3aa;box-shadow:0 0 0 3px rgba(52,195,170,.25),inset 0 1px 3px rgba(0,0,0,.1);}        
        button:not(.btn){width:100%;padding:12px;background:linear-gradient(to right,#1a6fc4,#34c3aa);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 6px rgba(0,0,0,.1),0 1px 3px rgba(0,0,0,.1);text-shadow:0 1px 2px rgba(0,0,0,.1);}        
        button:hover:not(.btn){background:linear-gradient(to right,#1558a0,#2aa890);box-shadow:0 6px 12px rgba(0,0,0,.15),0 2px 4px rgba(0,0,0,.15);transform:translateY(-2px);}        
        button:active:not(.btn){transform:translateY(0);box-shadow:0 2px 4px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.1);}        
        .error-message{color:#d93025;margin-top:15px;text-align:center;font-weight:600;}        
        .button-group{display:flex;flex-direction:column;gap:20px;margin-bottom:30px;}        
        .feature-btn{padding:20px;font-size:18px;font-weight:bold;position:relative;overflow:hidden;}        
        .feature-btn::after{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(255,255,255,.2),rgba(255,255,255,0));opacity:0;transition:opacity .3s ease;}        
        .feature-btn:hover::after{opacity:1;}        
        #inventory-btn{background:linear-gradient(to right,#34a853,#4aeb97);}#inventory-btn:hover{background:linear-gradient(to right,#2d9249,#3ed9a0);}        
        #event-btn{background:linear-gradient(to right,#ea4335,#ff6b58);}#event-btn:hover{background:linear-gradient(to right,#d33426,#e85a4a);}        
        /* ====== é€šçŸ¥åŠŸèƒ½æ–°å¢æ¨£å¼ ====== */
        #notification-btn{background:linear-gradient(to right,#ff9800,#ffb74d);}#notification-btn:hover{background:linear-gradient(to right,#f57c00,#ffa726);}        
        .notification-icon{position:absolute;top:8px;left:12px;cursor:pointer;font-size:18px;color:#ff9800;transition:all .3s ease;}
        .notification-icon:hover{color:#f57c00;transform:scale(1.1);}        
        .notification-badge{position:absolute;top:-5px;right:-8px;background:#ea4335;color:#fff;border-radius:50%;width:18px;height:18px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;}
        /* é€šçŸ¥ç®¡ç†é  */
        .notification-page{background:#fff;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1);padding:30px;margin-top:20px;width:100%;max-width:900px;margin-left:auto;margin-right:auto;}
        .notification-item{border:1px solid #dee2e6;border-radius:8px;padding:15px;margin-bottom:15px;background:#f8f9fa;transition:all .3s ease;}
        .notification-item:hover{box-shadow:0 4px 8px rgba(0,0,0,.1);}        
        .notification-item.unread{background:#fff3cd;border-color:#ffeaa7;}
        .notification-item.urgent{background:#f8d7da;border-color:#f5c6cb;}
        .notification-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
        .notification-title{font-weight:bold;color:#1a6fc4;margin:0;}
        .notification-time{font-size:12px;color:#6c757d;}
        .notification-content{color:#495057;margin-bottom:10px;}
        .notification-settings{background:#f8f9fa;border-radius:8px;padding:20px;margin-bottom:20px;}
        .notification-settings .setting-group{margin-bottom:15px;}        
        .notification-settings label{display:block;margin-bottom:5px;font-weight:600;color:#495057;}
        .notification-settings input,.notification-settings select{width:100%;padding:8px 12px;border:1px solid #ced4da;border-radius:4px;font-size:14px;}        
        /* å…¶ä»–åŸæœ‰æ¨£å¼ï¼ˆinventory, table ç­‰ï¼‰ç•¥ â€§ çš†ä¿ç•™ä¸å‹• */
    </style>
</head>
<body>
    <div class="container">
        <!-- ======== ç™»å…¥å€ ======== -->
        <div id="login-section" class="login-form">
            <div class="logo-container"><img src="LOGO.png" alt="æ˜¶é’å¯¦æ¥­ Logo" class="logo"></div>
            <h1>æ˜¶é’å¯¦æ¥­<br>ã€AIä¼æ¥­é¢¨æ§ä¸­å¿ƒã€‘</h1>
            <div class="form-group"><label for="username">å¸³è™Ÿ</label><input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"></div>
            <div class="form-group"><label for="password">å¯†ç¢¼</label><input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></div>
            <button id="login-btn">ç™»å…¥</button>
            <p id="loading" class="loading hidden">é©—è­‰ä¸­...</p><p id="error-message" class="error-message"></p>
        </div>

        <!-- ======== ä¸»åŠŸèƒ½é  ======== -->
        <div id="dashboard-section" class="dashboard hidden">
            <!-- ä½¿ç”¨è€…è³‡è¨Š + é€šçŸ¥ bell -->
            <div id="user-info" class="user-info" style="width:100%;text-align:center;">
                <div id="notification-icon" class="notification-icon" title="æŸ¥çœ‹é€šçŸ¥">ğŸ””<span id="notification-badge" class="notification-badge hidden">0</span></div>
                æ­¡è¿ï¼š<strong id="user-department"></strong> - <strong id="user-name"></strong>
            </div>
            <div class="logo-container"><img src="LOGO.png" alt="æ˜¶é’å¯¦æ¥­ Logo" class="logo"></div>
            <h1>æ˜¶é’å¯¦æ¥­<br>ã€AIä¼æ¥­é¢¨æ§ä¸­å¿ƒã€‘</h1>
            <div class="button-group">
                <button class="feature-btn" id="dept-risk-index-btn" style="background:linear-gradient(to right,#1a6fc4,#34c3aa);">éƒ¨é–€é¢¨éšªä¿‚æ•¸</button>
                <button id="inventory-btn" class="feature-btn">éƒ¨é–€é€±æœŸç›¤é»</button>
                <button id="event-btn" class="feature-btn">äº‹ä»¶ç™»éŒ„</button>
                <button id="notification-btn" class="feature-btn">é€šçŸ¥ç®¡ç†</button>
            </div>
            <!-- ç™»å‡º dropdown (æ²¿ç”¨åŸ) -->
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle w-100 py-2" type="button" id="logoutDropdown" data-bs-toggle="dropdown" aria-expanded="false">ç™»å‡ºé¸é …</button>
                <ul class="dropdown-menu w-100" aria-labelledby="logoutDropdown">
                    <li><a class="dropdown-item" href="#" id="changePasswordBtn">æ›´æ”¹å¯†ç¢¼</a></li>
                    <li><a class="dropdown-item" href="#" id="logoutBtn">ç™»å‡º</a></li>
                </ul>
            </div>
        </div>

        <!-- ======== é€šçŸ¥ç®¡ç†é  ======== -->
        <div id="notification-page" class="notification-page" style="display:none;">
            <div class="logo-container"><img src="LOGO.png" class="logo" alt="æ˜¶é’å¯¦æ¥­ Logo"></div>
            <h2 class="text-center mb-4">é€šçŸ¥ç®¡ç†</h2>
            <!-- è¨­å®š -->
            <div class="notification-settings">
                <h4>é€šçŸ¥è¨­å®š</h4>
                <div class="row">
                    <div class="col-md-6 setting-group"><label for="risk-threshold">é¢¨éšªé–¾å€¼è¨­å®š</label>
                        <select id="risk-threshold"><option value="20">ä½é¢¨éšª (Rå€¼ >20)</option><option value="30" selected>ä¸­é¢¨éšª (Rå€¼ >30)</option><option value="40">é«˜é¢¨éšª (Rå€¼ >40)</option></select></div>
                    <div class="col-md-6 setting-group"><label for="notification-frequency">æª¢æŸ¥é »ç‡</label>
                        <select id="notification-frequency"><option value="realtime" selected>å³æ™‚</option><option value="hourly">æ¯å°æ™‚</option><option value="daily">æ¯æ—¥</option></select></div>
                </div>
                <button class="btn btn-primary" id="save-settings-btn">å„²å­˜è¨­å®š</button>
                <button class="btn btn-info" id="check-risk-now-btn">ç«‹å³æª¢æŸ¥é¢¨éšª</button>
            </div>
            <!-- é€šçŸ¥åˆ—è¡¨è¦–åœ– -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>é€šçŸ¥è¨˜éŒ„</h4>
                <div>
                    <button class="btn btn-sm btn-outline-primary" id="mark-all-read-btn">å…¨éƒ¨æ¨™ç‚ºå·²è®€</button>
                    <button class="btn btn-sm btn-outline-danger" id="clear-notifications-btn">æ¸…é™¤æ‰€æœ‰é€šçŸ¥</button>
                </div>
            </div>
            <div id="notifications-container"><div class="text-center"><p>è¼‰å…¥é€šçŸ¥ä¸­...</p></div></div>
            <button class="btn btn-secondary mt-3" id="back-to-dashboard-from-notification">è¿”å›</button>
        </div>

        <!-- å…¶é¤˜é é¢ (deptâ€‘riskâ€‘index, inventory ç­‰) å®Œå…¨ç…§åŸæª”ä¿ç•™ï¼Œæ­¤è™•çœç•¥ä»¥ç¸®çŸ­ã€‚ -->
        <!-- ... åŸæœ¬çš„éƒ¨é–€é¢¨éšªä¿‚æ•¸é ã€éƒ¨é–€é€±æœŸç›¤é»é ã€ChangePassword Modal ç­‰ ... -->
    </div>

    <!-- Bootstrap / Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <!-- ========= ä¸» JavaScript ========= -->
    <script>
    document.addEventListener('DOMContentLoaded',function(){
        /* åŸæœ¬è®Šæ•¸å®£å‘Š */
        const loginSection=document.getElementById('login-section');
        const dashboardSection=document.getElementById('dashboard-section');
        const notificationPage=document.getElementById('notification-page');
        // å…¶ä»–èˆŠæœ‰ç¯€é»... (inventorySection, deptRiskIndexPage ç­‰)
        const notificationBtn=document.getElementById('notification-btn');
        const notificationIcon=document.getElementById('notification-icon');
        const notificationBadge=document.getElementById('notification-badge');
        // é€šçŸ¥é å…ƒä»¶
        const saveSettingsBtn=document.getElementById('save-settings-btn');
        const checkRiskNowBtn=document.getElementById('check-risk-now-btn');
        const markAllReadBtn=document.getElementById('mark-all-read-btn');
        const clearNotificationsBtn=document.getElementById('clear-notifications-btn');
        const notificationsContainer=document.getElementById('notifications-container');
        const riskThresholdSelect=document.getElementById('risk-threshold');
        const notificationFrequencySelect=document.getElementById('notification-frequency');
        const backFromNotificationBtn=document.getElementById('back-to-dashboard-from-notification');

        /* å…¶ä»–åŸæœ¬è®Šæ•¸... (usernameInput, passwordInput, inventoryBtn ç­‰) ä¿ç•™ä¸å‹• */

        /* åŸºæœ¬è¨­å®š */
        const inactivityTimeout=10*60*1000; // 10 åˆ†é˜
        let inactivityTimer, notificationCheckTimer;
        const scriptUrl='https://script.google.com/macros/s/AKfycbz6PrP-XVs2HkaPQFKArWyVKdT0tfMWU_7mR02dQhqHNnd64O3sQi6qCF2QcTIF88-x/exec'; // èˆ‡æ²’é€šçŸ¥ç‰ˆç›¸åŒ

        /* ========== é€šçŸ¥ç›¸é—œå‡½å¼ ========== */
        function loadNotificationSettings(){
            riskThresholdSelect.value=localStorage.getItem('riskThreshold')||'30';
            notificationFrequencySelect.value=localStorage.getItem('notificationFrequency')||'realtime';
        }

        function saveNotificationSettingsToBackend(){
            const payload={
                username:localStorage.getItem('username'),
                riskThreshold:riskThresholdSelect.value,
                notificationFrequency:notificationFrequencySelect.value
            };
            return fetch(`${scriptUrl}?action=saveNotificationSettings`,{method:'POST',body:JSON.stringify(payload)}).then(r=>r.json());
        }

        function updateNotificationBadge(){
            fetch(`${scriptUrl}?action=getUnreadNotificationCount&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(d=>{
                if(d.success){
                  const c=d.count;
                  if(c>0){notificationBadge.textContent=c>99?'99+':c;notificationBadge.classList.remove('hidden');}
                  else notificationBadge.classList.add('hidden');
                }
              }).catch(console.error);
        }

        function startNotificationCheck(){
            clearInterval(notificationCheckTimer);
            const freq=notificationFrequencySelect.value;
            let interval=30000; // default realtime 30s
            if(freq==='hourly') interval=3600000;
            else if(freq==='daily') interval=86400000;
            notificationCheckTimer=setInterval(()=>{
                if(localStorage.getItem('isLoggedIn')==='true'){
                    updateNotificationBadge();
                    fetch(`${scriptUrl}?action=checkRiskThreshold&username=${encodeURIComponent(localStorage.getItem('username'))}`).catch(console.error);
                }
            },interval);
        }

        function renderNotifications(list){
            if(!list.length){notificationsContainer.innerHTML='<div class="text-center"><p>ç›®å‰æ²’æœ‰é€šçŸ¥</p></div>';return;}
            notificationsContainer.innerHTML=list.map(n=>{
                const unread=!n.isRead?'unread':'';const urgent=n.priority==='urgent'?'urgent':'';
                return `<div class="notification-item ${unread} ${urgent}" data-id="${n.id}">
                    <div class="notification-header"><h5 class="notification-title">${n.title}</h5><span class="notification-time">${n.time}</span></div>
                    <div class="notification-content">${n.content}</div>
                    <div class="notification-actions">
                        ${!n.isRead?`<button class="btn btn-sm btn-primary mark-read-btn" data-id="${n.id}">æ¨™ç‚ºå·²è®€</button>`:''}
                        <button class="btn btn-sm btn-danger delete-notification-btn" data-id="${n.id}">åˆªé™¤</button>
                    </div></div>`;}).join('');
            // ç¶äº‹ä»¶
            notificationsContainer.querySelectorAll('.mark-read-btn').forEach(btn=>btn.addEventListener('click',()=>markNotificationAsRead(btn.dataset.id)));
            notificationsContainer.querySelectorAll('.delete-notification-btn').forEach(btn=>btn.addEventListener('click',()=>deleteNotification(btn.dataset.id)));
        }

        function loadNotifications(){
            notificationsContainer.innerHTML='<div class="text-center"><p>è¼‰å…¥é€šçŸ¥ä¸­...</p></div>';
            fetch(`${scriptUrl}?action=getNotifications&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(d=>{if(d.success)renderNotifications(d.notifications);else notificationsContainer.innerHTML='<div class="text-danger text-center">è¼‰å…¥å¤±æ•—</div>';})
              .catch(e=>{console.error(e);notificationsContainer.innerHTML='<div class="text-danger text-center">éŒ¯èª¤</div>';});
        }

        function markNotificationAsRead(id){
            fetch(`${scriptUrl}?action=markNotificationRead&notificationId=${id}&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(()=>{loadNotifications();updateNotificationBadge();});
        }
        function deleteNotification(id){
            if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;
            fetch(`${scriptUrl}?action=deleteNotification&notificationId=${id}&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(()=>{loadNotifications();updateNotificationBadge();});
        }

        /* ========== äº‹ä»¶ç¹«çµ (åªåˆ—æ–°å¢/æ”¹å‹•éƒ¨åˆ†) ========== */
        notificationBtn.addEventListener('click',()=>{dashboardSection.style.display='none';notificationPage.style.display='block';loadNotifications();});
        notificationIcon.addEventListener('click',()=>{dashboardSection.style.display='none';notificationPage.style.display='block';loadNotifications();});
        backFromNotificationBtn.addEventListener('click',()=>{notificationPage.style.display='none';dashboardSection.style.display='block';});

        saveSettingsBtn.addEventListener('click',()=>{
            localStorage.setItem('riskThreshold',riskThresholdSelect.value);
            localStorage.setItem('notificationFrequency',notificationFrequencySelect.value);
            saveNotificationSettingsToBackend().then(d=>{if(d.success){alert('è¨­å®šå·²å„²å­˜');startNotificationCheck();}else alert('å„²å­˜å¤±æ•—');});
        });
        checkRiskNowBtn.addEventListener('click',()=>{
            checkRiskNowBtn.disabled=true;checkRiskNowBtn.textContent='æª¢æŸ¥ä¸­...';
            fetch(`${scriptUrl}?action=checkRiskThreshold&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(r=>r.json()).then(d=>{
                checkRiskNowBtn.disabled=false;checkRiskNowBtn.textContent='ç«‹å³æª¢æŸ¥é¢¨éšª';
                if(d.success){if(d.notifications.length){alert(`ç™¼ç¾ ${d.notifications.length} å€‹é¢¨éšªè­¦å‘Š`);}else alert('ç›®å‰æ²’æœ‰é¢¨éšªè­¦å‘Š');loadNotifications();updateNotificationBadge();}
              }).catch(()=>{checkRiskNowBtn.disabled=false;checkRiskNowBtn.textContent='ç«‹å³æª¢æŸ¥é¢¨éšª';});
        });
        markAllReadBtn.addEventListener('click',()=>{
            fetch(`${scriptUrl}?action=markAllNotificationsRead&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(()=>{loadNotifications();updateNotificationBadge();});
        });
        clearNotificationsBtn.addEventListener('click',()=>{
            if(!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é€šçŸ¥å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚'))return;
            fetch(`${scriptUrl}?action=clearAllNotifications&username=${encodeURIComponent(localStorage.getItem('username'))}`)
              .then(()=>{loadNotifications();updateNotificationBadge();});
        });

        /* ======= ä¸‹æ–¹å…¶é¤˜åŸæœ‰ JSï¼ˆç™»å…¥ã€inventoryã€deptâ€‘risk ç­‰å‡½å¼ï¼‰ç…§èˆŠï¼Œåƒ…åœ¨ submitInventory æˆåŠŸå¾Œå¤šå‘¼å« updateNotificationBadge() ======= */
        // ... (ä¿æŒåŸç¢¼ä¸æ”¹å‹•ï¼Œåƒ…åœ¨å°æ‡‰ä½ç½®æ’å…¥ updateNotificationBadge();)
    });
    </script>
</body>
</html>
