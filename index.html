<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>昶青實業-AI控制管理中心</title>
    <!-- 新增 Bootstrap CSS 用於下拉選單 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: '微軟正黑體', Arial, sans-serif; }
        body { background-color: #f5f5f5; min-height: 100vh; position: relative; padding: 20px; }
        .container { width: 100%; max-width: 500px; padding: 20px; margin: 0 auto; position: relative; }
        .login-form, .dashboard { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; margin-bottom: 30px; color: #333; font-size: 24px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button:not(.btn) { width: 100%; padding: 12px; background-color: #4285f4; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover:not(.btn) { background-color: #3367d6; }
        .error-message { color: #d93025; margin-top: 15px; text-align: center; }
        .button-group { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .feature-btn { padding: 20px; font-size: 18px; font-weight: bold; }
        #inventory-btn { background-color: #34a853; }
        #inventory-btn:hover { background-color: #2d9249; }
        #event-btn     { background-color: #ea4335; }
        #event-btn:hover { background-color: #d33426; }
        .hidden { display: none; }
        .loading { text-align: center; margin-top: 15px; }
        .user-info { text-align: right; margin-bottom: 15px; font-size: 14px; color: #555; }
        .user-info strong { color: #4285f4; }
        .dropdown { margin-top: 20px; }
        .inventory-section { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 900px; position: absolute; left:50%; transform: translateX(-50%); margin-top:20px; }
        .container.hidden { display: none; }
        .inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .back-btn:hover { background-color: #5a6268; }
        .inventory-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .inventory-table th, .inventory-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .inventory-table th { background-color: #f8f9fa; font-weight: bold; }
        .inventory-table tr:nth-child(even) { background-color: #f2f2f2; }
        .inventory-actions { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .submit-btn { background-color: #34a853; width: 150px; }
        .submit-btn:hover { background-color: #2d9249; }
        .reset-btn { background-color: #ea4335; width: 150px; }
        .reset-btn:hover { background-color: #d33426; }
        .select-container, .input-container { margin-bottom: 0; }
        .select-container select, .input-container input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .input-container input[disabled] { background-color: #e9ecef; cursor: not-allowed; }
        .risk-info { margin-bottom: 10px; }
        .risk-name { font-weight: bold; color: #333; }
        .risk-description { color: #666; font-size: 14px; }
        .risk-category, .risk-level, .related-departments { font-size: 13px; color: #777; }
        @media (max-width: 768px) {
            .inventory-section { padding: 15px; }
            .inventory-table th, .inventory-table td { padding: 8px; font-size: 14px; }
            .inventory-actions { flex-direction: column; align-items: center; }
            .submit-btn, .reset-btn { width: 100%; margin-bottom: 10px; }
        }
        @media (max-width: 480px) {
            .container { padding: 10px; }
            h1 { font-size: 20px; }
            .feature-btn { padding: 15px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登入表單 -->
        <div id="login-section" class="login-form">
            <h1>昶青實業-AI控制管理中心</h1>
            <div class="form-group">
                <label for="username">帳號</label>
                <input type="text" id="username" placeholder="請輸入帳號">
            </div>
            <div class="form-group">
                <label for="password">密碼</label>
                <input type="password" id="password" placeholder="請輸入密碼">
            </div>
            <button id="login-btn">登入</button>
            <p id="loading" class="loading hidden">驗證中...</p>
            <p id="error-message" class="error-message"></p>
        </div>

        <!-- 主頁面 -->
        <div id="dashboard-section" class="dashboard hidden">
            <div id="user-info" class="user-info">歡迎： <strong id="user-department"></strong> - <strong id="user-name"></strong></div>
            <h1>昶青實業-AI控制管理中心</h1>
            <div class="button-group">
                <button id="inventory-btn" class="feature-btn">部門週期盤點</button>
                <button id="event-btn" class="feature-btn">事件登錄</button>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle w-100 py-2" type="button" id="logoutDropdown" data-bs-toggle="dropdown" aria-expanded="false">登出選項</button>
                <ul class="dropdown-menu w-100" aria-labelledby="logoutDropdown">
                    <li><a class="dropdown-item" href="#" id="changePasswordBtn">更改密碼</a></li>
                    <li><a class="dropdown-item" href="#" id="logoutBtn">登出</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 更改密碼的彈出視窗 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">更改密碼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">目前密碼</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">新密碼</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">確認新密碼</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <div id="passwordChangeMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitChangePassword">確認更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 部門週期盤點頁 -->
    <div id="inventory-section" class="inventory-section hidden">
        <div class="inventory-header">
            <h1>部門週期盤點</h1>
            <button id="back-btn" class="back-btn">返回前頁</button>
        </div>
        <div id="inventory-loading" class="loading">載入中，請稍候...</div>
        <div id="inventory-content" class="hidden">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th style="width:40%">風險項目</th>
                        <th style="width:20%">本月是否增加 <button id="select-none-btn" class="btn btn-sm btn-outline-secondary">一鍵全否</button></th>
                        <th style="width:15%">發生次數</th>
                        <th style="width:25%">原因</th>
                    </tr>
                </thead>
                <tbody id="inventory-table-body"></tbody>
            </table>
            <div class="inventory-actions">
                <button id="submit-inventory-btn" class="submit-btn">送出</button>
                <button id="reset-inventory-btn" class="reset-btn">重置</button>
            </div>
        </div>
    </div>

    <!-- 新增 Bootstrap JS 和 Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const inventorySection = document.getElementById('inventory-section');
        const loginBtn = document.getElementById('login-btn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const loadingMsg = document.getElementById('loading');
        const inventoryBtn = document.getElementById('inventory-btn');
        const eventBtn = document.getElementById('event-btn');
        const logoutBtn = document.getElementById('logoutBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const submitChangePasswordBtn = document.getElementById('submitChangePassword');
        const userDepartment = document.getElementById('user-department');
        const userName = document.getElementById('user-name');
        const backBtn = document.getElementById('back-btn');
        const submitInventoryBtn = document.getElementById('submit-inventory-btn');
        const resetInventoryBtn = document.getElementById('reset-inventory-btn');
        const inventoryTableBody = document.getElementById('inventory-table-body');
        const inventoryLoading = document.getElementById('inventory-loading');
        const inventoryContent = document.getElementById('inventory-content');
        const selectNoneBtn = document.getElementById('select-none-btn');

        // 自動登出相關變數
        let inactivityTimer;
        const inactivityTimeout = 2 * 60 * 1000; // 15 分鐘

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (localStorage.getItem('isLoggedIn') === 'true') {
                inactivityTimer = setTimeout(autoLogout, inactivityTimeout);
            }
        }

        function autoLogout() {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                alert('因長時間未操作，系統已自動登出');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                localStorage.removeItem('department');
                localStorage.removeItem('name');
                showLogin();
            }
        }

        ['mousedown','mousemove','keypress','scroll','touchstart'].forEach(evt => {
            document.addEventListener(evt, resetInactivityTimer, true);
        });

        const scriptUrl = 'https://script.google.com/macros/s/AKfycbzZWj-Per8eT-uEfLpk4B1qYtQKQ9KGjYQUXThNtSoKAsvGsqR61L-7HmchCM9Ya33a/exec';

        if (localStorage.getItem('isLoggedIn') === 'true') {
            userDepartment.textContent = localStorage.getItem('department') || '';
            userName.textContent = localStorage.getItem('name') || '';
            showDashboard();
            resetInactivityTimer();
        }

        loginBtn.addEventListener('click', function() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            if (!username || !password) {
                errorMessage.textContent = '請輸入帳號和密碼'; return;
            }
            errorMessage.textContent = ''; loadingMsg.classList.remove('hidden'); loginBtn.disabled = true;
            fetch(`${scriptUrl}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`)
            .then(response => response.json())
            .then(data => {
                loadingMsg.classList.add('hidden'); loginBtn.disabled = false;
                if (data.success) {
                    localStorage.setItem('isLoggedIn','true');
                    localStorage.setItem('username',username);
                    localStorage.setItem('department',data.department||'');
                    localStorage.setItem('name',data.name||'');
                    userDepartment.textContent = data.department||'';
                    userName.textContent = data.name||'';
                    showDashboard(); resetInactivityTimer();
                } else {
                    errorMessage.textContent = data.message|| '帳號或密碼錯誤';
                }
            })
            .catch(error => {
                loadingMsg.classList.add('hidden'); loginBtn.disabled = false;
                errorMessage.textContent = '系統錯誤，請稍後再試'; console.error(error);
            });
        });

        inventoryBtn.addEventListener('click', function() { showInventorySection(); loadInventoryData(); resetInactivityTimer(); });
        backBtn.addEventListener('click', function() { showDashboard(); resetInactivityTimer(); });

        function loadInventoryData() {
            const department = localStorage.getItem('department');
            if (!department) { alert('無法獲取部門資訊，請重新登入'); showLogin(); return; }
            inventoryLoading.classList.remove('hidden'); inventoryContent.classList.add('hidden'); inventoryTableBody.innerHTML = '';
            fetch(`${scriptUrl}?action=getRiskItems&department=${encodeURIComponent(department)}`)
            .then(response => response.json())
            .then(data => {
                inventoryLoading.classList.add('hidden');
                if (data.success) { renderRiskItems(data.items); inventoryContent.classList.remove('hidden'); }
                else { alert(data.message|| '無法獲取風險清單'); }
                resetInactivityTimer();
            })
            .catch(error => { inventoryLoading.classList.add('hidden'); alert('系統錯誤，請稍後再試'); console.error(error); });
        }

        function renderRiskItems(items) {
            inventoryTableBody.innerHTML = '';
            if (!items.length) {
                inventoryTableBody.innerHTML = '<tr><td colspan="4" class="text-center">沒有風險項目</td></tr>';
                return;
            }
            items.forEach((item, index) => {
                const tr = document.createElement('tr'); tr.setAttribute('data-risk-id', index);
                tr.innerHTML = `
                    <td>
                        <div class="risk-info">
                            <div class="risk-name">${item.name}</div>
                            <div class="risk-description">${item.description}</div>
                            <div class="risk-category">類別: ${item.category}</div>
                            <div class="risk-level">風險等級: ${item.level}</div>
                            <div class="related-departments">相關聯部門: ${item.relatedDepartments}</div>
                        </div>
                    </td>
                    <td>
                        <div class="select-container">
                            <select class="increase-select form-select form-select-sm" data-index="${index}">
                                <option value="">請選擇</option>
                                <option value="yes">是</option>
                                <option value="no">否</option>
                            </select>
                        </div>
                    </td>
                    <td><input type="number" class="occurrence-input form-control form-control-sm" data-index="${index}" disabled></td>
                    <td><input type="text" class="reason-input form-control form-control-sm" data-index="${index}" disabled></td>
                `;
                inventoryTableBody.appendChild(tr);
            });
            document.querySelectorAll('.increase-select').forEach(select => {
                select.addEventListener('change', function() {
                    const idx = this.dataset.index;
                    const occ = document.querySelector(`.occurrence-input[data-index='${idx}']`);
                    const rea = document.querySelector(`.reason-input[data-index='${idx}']`);
                    if (this.value === 'yes') { occ.disabled = false; rea.disabled = false; occ.required=true; rea.required=true; }
                    else { occ.disabled=true; rea.disabled=true; occ.required=false; rea.required=false; occ.value=''; rea.value=''; }
                });
            });
        }

        // 一鍵全否
        selectNoneBtn.addEventListener('click', function() {
            document.querySelectorAll('.increase-select').forEach(sel => { sel.value='no'; sel.dispatchEvent(new Event('change')); });
        });

        submitInventoryBtn.addEventListener('click', function() {
            let isValid=true; const responses=[];
            document.querySelectorAll('.increase-select').forEach(select => {
                const idx=select.dataset.index;
                const occ=document.querySelector(`.occurrence-input[data-index='${idx}']`);
                const rea=document.querySelector(`.reason-input[data-index='${idx}']`);
                const row=document.querySelector(`tr[data-risk-id='${idx}']`);
                const riskName=row.querySelector('.risk-name').textContent;
                const riskDescription=row.querySelector('.risk-description').textContent;
                const riskCategory=row.querySelector('.risk-category').textContent.replace('類別: ','');
                const riskLevel=row.querySelector('.risk-level').textContent.replace('風險等級: ','');
                const relatedDepartments=row.querySelector('.related-departments').textContent.replace('相關聯部門: ','');
                if(select.value===''){ isValid=false; select.style.borderColor='red'; }
                else {
                    select.style.borderColor='';
                    if(select.value==='yes'){ if(!occ.value){ isValid=false; occ.style.borderColor='red'; } else occ.style.borderColor=''; if(!rea.value){ isValid=false; rea.style.borderColor='red'; } else rea.style.borderColor=''; }
                    responses.push({ index:idx, riskName, riskDescription, riskCategory, riskLevel, relatedDepartments, increased:select.value==='yes', occurrences:select.value==='yes'?occ.value:0, reason:select.value==='yes'?rea.value:'' });
                }
            });
            if(!isValid){ alert('請填寫所有必填欄位'); return; }
            const dept=localStorage.getItem('department'); const user=localStorage.getItem('username'); const name=localStorage.getItem('name');
            const now=new Date().toISOString();
            submitInventoryBtn.disabled=true; submitInventoryBtn.textContent='送出中...';
            fetch(`${scriptUrl}?action=submitInventory`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ timestamp:now, department:dept, username:user, name:name, responses:responses, sheetName:'定期紀錄' }) })
            .then(r=>r.json()).then(data=>{ submitInventoryBtn.disabled=false; submitInventoryBtn.textContent='送出'; if(data.success){ alert('部門週期盤點已成功送出'); showDashboard(); } else{ alert(data.message||'送出失敗，請稍後再試'); } resetInactivityTimer(); }).catch(err=>{ submitInventoryBtn.disabled=false; submitInventoryBtn.textContent='送出'; alert('系統錯誤，請稍後再試'); console.error(err); });
        });

        resetInventoryBtn.addEventListener('click', function() {
            document.querySelectorAll('.increase-select').forEach(select => { select.value=''; select.style.borderColor=''; const idx=select.dataset.index; const occ=document.querySelector(`.occurrence-input[data-index='${idx}']`); const rea=document.querySelector(`.reason-input[data-index='${idx}']`); occ.value=''; occ.disabled=true; occ.style.borderColor=''; rea.value=''; rea.disabled=true; rea.style.borderColor=''; }); resetInactivityTimer();
        });

        eventBtn.addEventListener('click', function() { alert('將導向事件登錄功能'); resetInactivityTimer(); });
        logoutBtn.addEventListener('click', function() { localStorage.clear(); clearTimeout(inactivityTimer); showLogin(); });
        changePasswordBtn.addEventListener('click', function() { document.getElementById('changePasswordForm').reset(); document.getElementById('passwordChangeMessage').style.display='none'; new bootstrap.Modal(document.getElementById('changePasswordModal')).show(); resetInactivityTimer(); });
        submitChangePasswordBtn.addEventListener('click', function() { const cur=document.getElementById('currentPassword').value; const nw=document.getElementById('newPassword').value; const cf=document.getElementById('confirmPassword').value; const msg=document.getElementById('passwordChangeMessage'); if(nw!==cf){ msg.className='alert alert-danger'; msg.textContent='新密碼與確認密碼不一致！'; msg.style.display='block'; return; } fetch(`${scriptUrl}?action=changePassword&username=${encodeURIComponent(localStorage.getItem('username'))}&currentPassword=${encodeURIComponent(cur)}&newPassword=${encodeURIComponent(nw)}`) .then(r=>r.json()).then(data=>{ if(data.success){ msg.className='alert alert-success'; msg.textContent='密碼更改成功！'; msg.style.display='block'; setTimeout(() =>{ bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide(); document.getElementById('changePasswordForm').reset(); msg.style.display='none'; }, 3000); } else{ msg.className='alert alert-danger'; msg.textContent=data.message||'密碼更改失敗！'; msg.style.display='block'; } resetInactivityTimer(); }).catch(err=>{ msg.className='alert alert-danger'; msg.textContent='系統錯誤，請稍後再試'; msg.style.display='block'; console.error(err); }); });

        function showDashboard(){ loginSection.classList.add('hidden'); inventorySection.classList.add('hidden'); document.querySelector('.container').classList.remove('hidden'); dashboardSection.classList.remove('hidden'); document.querySelector('.container').style.maxWidth='500px'; resetInactivityTimer(); }
        function showLogin(){ dashboardSection.classList.add('hidden'); inventorySection.classList.add('hidden'); document.querySelector('.container').classList.remove('hidden'); loginSection.classList.remove('hidden'); usernameInput.value=''; passwordInput.value=''; errorMessage.textContent=''; document.querySelector('.container').style.maxWidth='500px'; clearTimeout(inactivityTimer); }
        function showInventorySection(){ loginSection.classList.add('hidden'); dashboardSection.classList.add('hidden'); document.querySelector('.container').classList.add('hidden'); inventorySection.classList.remove('hidden'); resetInactivityTimer(); }
    });
    </script>
</body>
</html>
