<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>昶青實業-AI風控管理中心</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .auth-box {
      max-width: 400px;
      margin: 5% auto;
      padding: 25px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      position: relative;
    }
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .blink-warning {
      animation: blinker 1s linear infinite;
      color: #dc3545;
    }
    @keyframes blinker {
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-light">
  <div class="container">
    <div class="auth-box bg-white rounded-3 p-4">
      <div class="loading-overlay" id="globalLoader">
        <div class="spinner-border text-primary"></div>
      </div>
      
      <h2 class="mb-4 text-center">AI風控管理中心</h2>
      <form id="loginForm" onsubmit="return handleLogin(event)">
        <!-- 部門選擇 -->
        <div class="mb-3">
          <label class="form-label">部門</label>
          <select id="department" class="form-select" required
                  onchange="loadNames(this.value)">
            <option value="" disabled selected>載入中...</option>
          </select>
          <div class="invalid-feedback" id="deptError"></div>
        </div>

        <!-- 姓名選擇 -->
        <div class="mb-3">
          <label class="form-label">姓名</label>
          <select id="name" class="form-select" required disabled
                  onchange="loadAccount(this.value)">
            <option value="" disabled selected>請先選擇部門</option>
          </select>
        </div>

        <!-- 帳號顯示 -->
        <div class="mb-3">
          <label class="form-label">帳號</label>
          <input type="text" id="account" class="form-control" readonly>
        </div>

        <!-- 密碼輸入 -->
        <div class="mb-4">
          <label class="form-label">密碼</label>
          <div class="input-group">
            <input type="password" id="password" class="form-control" required>
            <button type="button" class="btn btn-outline-secondary" 
                    onclick="togglePasswordVisibility()">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          <div class="invalid-feedback" id="pwdError"></div>
        </div>

        <button type="submit" class="btn btn-primary w-100 position-relative">
          登入系統
          <div class="spinner-border spinner-border-sm loading-spinner" 
               style="display: none;" id="submitSpinner"></div>
        </button>
      </form>
    </div>
  </div>

  <script>
    //=== 全局狀態管理 ===//
    let appState = {
      currentDept: null,
      userData: null,
      retryCount: 0
    };

    //=== 初始化載入 ===//
    document.addEventListener('DOMContentLoaded', () => {
      toggleGlobalLoader(true);
      google.script.run
        .withSuccessHandler(data => {
          populateDepartments(data);
          toggleGlobalLoader(false);
        })
        .withFailureHandler(err => {
          showCriticalError('部門初始化失敗', err);
          toggleGlobalLoader(false);
        })
        .getDepartments();
    });

    //=== 部門載入處理 ===//
    function populateDepartments(departments) {
      const deptSelect = document.getElementById('department');
      if (!departments || departments.length === 0) {
        deptSelect.innerHTML = '<option value="" disabled selected>無可用部門</option>';
        showCriticalError('部門數據異常', '未找到有效部門數據');
        return;
      }

      deptSelect.innerHTML = departments.map(dept => 
        `<option value="${dept}">${dept}</option>`
      ).join('');
      deptSelect.removeAttribute('disabled');
    }

    //=== 姓名載入處理 ===//
    function loadNames(selectedDept) {
      appState.currentDept = selectedDept;
      const nameSelect = document.getElementById('name');
      nameSelect.setAttribute('disabled', true);
      nameSelect.innerHTML = '<option value="" disabled selected>載入中...</option>';

      toggleGlobalLoader(true);
      google.script.run
        .withSuccessHandler(names => {
          nameSelect.innerHTML = names.map(name => 
            `<option value="${name}">${name}</option>`
          ).join('');
          nameSelect.removeAttribute('disabled');
          document.getElementById('account').value = '';
          toggleGlobalLoader(false);
        })
        .withFailureHandler(err => {
          showCriticalError('人員載入失敗', err);
          toggleGlobalLoader(false);
        })
        .getNamesByDepartment(selectedDept);
    }

    //=== 帳號載入處理 ===//
    function loadAccount(selectedName) {
      toggleGlobalLoader(true);
      google.script.run
        .withSuccessHandler(account => {
          document.getElementById('account').value = account || '未找到對應帳號';
          toggleGlobalLoader(false);
        })
        .withFailureHandler(err => {
          showCriticalError('帳號查詢失敗', err);
          toggleGlobalLoader(false);
        })
        .getAccountInfo(appState.currentDept, selectedName);
    }

    //=== 登入處理 ===//
    function handleLogin(event) {
      event.preventDefault();
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const spinner = document.getElementById('submitSpinner');
      
      submitBtn.setAttribute('disabled', true);
      spinner.style.display = 'inline-block';

      const formData = {
        department: document.getElementById('department').value,
        name: document.getElementById('name').value,
        account: document.getElementById('account').value,
        password: document.getElementById('password').value
      };

      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            window.location.href = response.redirectUrl;
          } else {
            handleLoginError(response.error);
          }
        })
        .withFailureHandler(err => {
          handleLoginError(err.message);
        })
        .processLogin(formData);
    }

    //=== 錯誤處理 ===//
    function handleLoginError(error) {
      appState.retryCount++;
      const pwdField = document.getElementById('password');
      pwdField.classList.add('is-invalid');
      document.getElementById('pwdError').textContent = `登入失敗 (${appState.retryCount}/3): ${error}`;
      
      if (appState.retryCount >= 3) {
        document.getElementById('loginForm').reset();
        appState.retryCount = 0;
        alert('已達錯誤次數上限，表單已重置');
      }
    }

    //=== 工具函數 ===//
    function toggleGlobalLoader(show) {
      document.getElementById('globalLoader').style.display = show ? 'flex' : 'none';
    }

    function togglePasswordVisibility() {
      const pwdField = document.getElementById('password');
      pwdField.type = pwdField.type === 'password' ? 'text' : 'password';
    }

    function showCriticalError(title, message) {
      const errorHtml = `
        <div class="alert alert-danger mt-3">
          <h5>${title}</h5>
          <pre class="mb-0">${message}</pre>
        </div>
      `;
      document.querySelector('.auth-box').insertAdjacentHTML('beforeend', errorHtml);
    }
  </script>
</body>
</html>
